{% extends 'myapp/base.html' %}
{% load static %}

{% block content %}
<head>
  <link rel="stylesheet" href="{% static 'css/tests/practice_tests.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<div class="practice-tests-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">Practice Tests</h1>
        <p class="page-subtitle">Master your skills with comprehensive practice tests and AI-generated assessments</p>
      </div>
      <div class="header-actions">
        <a href="{% url 'create_practice_test' %}" class="btn btn-create">
          <i class="fas fa-plus"></i>
          Create Manually
        </a>
        <button class="btn btn-ai" id="open-ai-modal">
          <i class="fas fa-wand-magic-sparkles"></i>
          Generate with AI
        </button>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="searchInput" placeholder="Search practice tests..." class="search-input">
    </div>
    
    <div class="filter-controls">
      <div class="filter-group">
        <label for="difficultyFilter" class="filter-label">
          <i class="fas fa-signal"></i>
          Difficulty
        </label>
        <select id="difficultyFilter" class="filter-select">
          <option value="all">All Levels</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="sortFilter" class="filter-label">
          <i class="fas fa-sort"></i>
          Sort By
        </label>
        <select id="sortFilter" class="filter-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="name-asc">Name (A-Z)</option>
          <option value="name-desc">Name (Z-A)</option>
        </select>
      </div>
      
      <button class="btn-reset-filters" id="resetFilters">
        <i class="fas fa-rotate-right"></i>
        Reset
      </button>
    </div>
  </div>



  <!-- Practice Test Grid -->
  <div class="practice-test-grid" id="practiceTestGrid">
    {% for practice_test in tests %}
    <div class="practice-test-card" data-title="{{ practice_test.title|lower }}" data-difficulty="{{ practice_test.difficulty|default:'medium'|lower }}" data-date="{{ practice_test.created_at|date:'Y-m-d' }}">
      <div class="card-header">
        <div class="card-badge">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="card-difficulty {{ practice_test.difficulty|default:'medium'|lower }}">
          <i class="fas fa-signal"></i>
          {{ practice_test.difficulty|default:'Medium' }}
        </div>
      </div>
      
      <div class="card-content">
        <h2 class="card-title">{{ practice_test.title }}</h2>
        <p class="card-description">{{ practice_test.description|default:"No description provided." }}</p>
        
        <div class="card-meta">
          {% if practice_test.question_count %}
          <div class="meta-item">
            <i class="fas fa-question-circle"></i>
            <span>{{ practice_test.question_count }} questions</span>
          </div>
          {% endif %}
          {% if practice_test.duration %}
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>{{ practice_test.duration }} min</span>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="card-footer">
        <button class="btn-take-test" onclick="openModal('Begin Test', [['Take Test', '{% url 'take_practice_test' practice_test.id %}', 'blue']])">
          <i class="fas fa-play"></i>
          Take Test
        </button>
        <div class="card-actions">
            <a href="{% url 'edit_practice_test' practice_test.id %}" class="btn-icon" title="Edit">
          <button class="btn-icon" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
        </a>

        <form action="{% url 'delete_practice_test' practice_test.id %}" method="POST" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-icon" title="Delete" onclick="return confirm('Are you sure?')">
                <i class="fas fa-trash"></i>
            </button>
        </form>

        </div>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-clipboard-list"></i>
      </div>
      <h3>No Practice Tests Yet</h3>
      <p>Get started by creating your first practice test manually or with AI assistance</p>
      <div class="empty-actions">
        <a href="{% url 'create_practice_test' %}" class="btn btn-create" style="background: white !important; color: blue;">
          <i class="fas fa-plus"></i>
          Create Manually
        </a>
        <button class="btn btn-ai" id="open-ai-modal-empty">
          <i class="fas fa-wand-magic-sparkles"></i>
          Generate with AI
        </button>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- No Results Message -->
  <div class="no-results" id="noResults" style="display: none;">
    <div class="empty-icon">
      <i class="fas fa-search"></i>
    </div>
    <h3>No Tests Found</h3>
    <p>Try adjusting your search or filters</p>
    <button class="btn-reset-filters" onclick="document.getElementById('resetFilters').click()">
      <i class="fas fa-rotate-right"></i>
      Reset Filters
    </button>
  </div>
</div>

<!-- AI Modal -->
<div id="ai-modal" class="modal">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="modal-close" aria-label="Close modal">
      <i class="fas fa-times"></i>
    </button>
    
    <div class="modal-header">
      <div class="modal-icon">
        <i class="fas fa-wand-magic-sparkles"></i>
      </div>
      <h2 class="modal-title">Create Practice Test with AI</h2>
      <p class="modal-subtitle">Let AI generate a customized practice test based on your requirements</p>
    </div>
    
    <form id="ai-practice-form" enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="prompt" class="form-label">
          <i class="fas fa-lightbulb"></i>
          Topic or Instructions
        </label>
        <textarea name="prompt" id="prompt" rows="4" placeholder="E.g., 'Create a test on Python programming basics covering variables, loops, and functions'" required></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="amount" class="form-label">
            <i class="fas fa-hashtag"></i>
            Number of Questions
          </label>
          <input type="number" name="amount" id="amount" value="5" min="1" max="50" required>
        </div>
        
        <div class="form-group">
          <label for="duration" class="form-label">
            <i class="fas fa-clock"></i>
            Duration (minutes)
          </label>
          <input type="number" name="duration" id="duration" value="30" min="1" required>
        </div>
      </div>
      
      <div class="form-group">
        <label for="difficulty" class="form-label">
          <i class="fas fa-signal"></i>
          Difficulty Level
        </label>
        <select name="difficulty" id="difficulty">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="file" class="form-label">
          <i class="fas fa-file-upload"></i>
          Optional File Upload
        </label>
        <div class="file-upload-wrapper">
          <input type="file" name="file" id="file" accept=".txt,.csv,.pdf" class="file-input">
          <label for="file" class="file-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span class="file-text">Choose a file or drag here</span>
          </label>
        </div>
      </div>
      
      <button type="submit" class="btn btn-submit">
        <i class="fas fa-wand-magic-sparkles"></i>
        Generate Practice Test
      </button>
    </form>
    
    <div id="ai-form-message" class="form-message"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Modal functionality
  const modal = document.getElementById("ai-modal");
  const openBtns = [
    document.getElementById("open-ai-modal"),
    document.getElementById("open-ai-modal-empty")
  ].filter(btn => btn !== null);
  const closeBtn = document.querySelector(".modal-close");
  const modalOverlay = document.querySelector(".modal-overlay");
  const form = document.getElementById("ai-practice-form");
  const messageDiv = document.getElementById("ai-form-message");
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  // Open modal
  openBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      modal.classList.add("active");
      document.body.style.overflow = "hidden";
    });
  });

  // Close modal
  const closeModal = () => {
    modal.classList.remove("active");
    document.body.style.overflow = "";
  };

  closeBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", closeModal);

  // File upload styling
  const fileInput = document.getElementById("file");
  const fileText = document.querySelector(".file-text");
  
  fileInput.addEventListener("change", (e) => {
    if (e.target.files.length > 0) {
      fileText.textContent = e.target.files[0].name;
    } else {
      fileText.textContent = "Choose a file or drag here";
    }
  });

  // AJAX form submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const submitBtn = form.querySelector(".btn-submit");
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    messageDiv.innerHTML = "";

    const formData = new FormData(form);

    try {
      const response = await fetch("{% url 'create_ai_activity' 'practice_test' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken
        },
        body: formData
      });

      const data = await response.json();
      if (data.success) {
        messageDiv.innerHTML = '<div class="message-success"><i class="fas fa-check-circle"></i> Test created successfully! Redirecting...</div>';
        setTimeout(() => { window.location.href = data.redirect_url; }, 1000);
      } else {
        messageDiv.innerHTML = `<div class="message-error"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Practice Test';
      }
    } catch (err) {
      console.error(err);
      messageDiv.innerHTML = '<div class="message-error"><i class="fas fa-exclamation-circle"></i> Unexpected error occurred.</div>';
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Practice Test';
    }
  });

  // Search and Filter functionality
  const searchInput = document.getElementById("searchInput");
  const difficultyFilter = document.getElementById("difficultyFilter");
  const sortFilter = document.getElementById("sortFilter");
  const resetBtn = document.getElementById("resetFilters");
  const testCards = document.querySelectorAll(".practice-test-card");
  const noResults = document.getElementById("noResults");

  function filterAndSort() {
    const searchTerm = searchInput.value.toLowerCase();
    const difficultyValue = difficultyFilter.value;
    const sortValue = sortFilter.value;
    
    let visibleCards = Array.from(testCards).filter(card => {
      const title = card.dataset.title;
      const difficulty = card.dataset.difficulty;
      
      const matchesSearch = title.includes(searchTerm);
      const matchesDifficulty = difficultyValue === "all" || difficulty === difficultyValue;
      
      return matchesSearch && matchesDifficulty;
    });

    // Sort cards
    visibleCards.sort((a, b) => {
      switch(sortValue) {
        case "newest":
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        case "oldest":
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case "name-asc":
          return a.dataset.title.localeCompare(b.dataset.title);
        case "name-desc":
          return b.dataset.title.localeCompare(a.dataset.title);
        default:
          return 0;
      }
    });

    // Hide all cards first
    testCards.forEach(card => card.style.display = "none");

    // Show and reorder visible cards
    const grid = document.getElementById("practiceTestGrid");
    visibleCards.forEach(card => {
      card.style.display = "block";
      grid.appendChild(card);
    });

    // Update count and show/hide no results
    noResults.style.display = visibleCards.length === 0 ? "flex" : "none";
  }

  searchInput.addEventListener("input", filterAndSort);
  difficultyFilter.addEventListener("change", filterAndSort);
  sortFilter.addEventListener("change", filterAndSort);

  resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    difficultyFilter.value = "all";
    sortFilter.value = "newest";
    filterAndSort();
  });
});
</script>
{% endblock %}