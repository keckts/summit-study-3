{% extends "myapp/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress/progress.css' %}">

<div class="progress-container">
    <!-- Header -->
    <div class="progress-header">
        <h1>My Progress Dashboard</h1>
        <p class="subtitle">Track your learning journey</p>
    </div>

        <!-- Navigation Tabs -->
    <nav class="progress-nav">
        <button class="nav-btn active" data-tab="overview">
            Overview
        </button>

        <button class="nav-btn" data-tab="performance">
            Performance
        </button>
        <button class="nav-btn" data-tab="recent">
            Recent Activity
        </button>
        <button class="nav-btn" data-tab="insights">
            AI Insights
        </button>
    </nav>

    <!-- Tab Content -->
    <div class="tab-content-wrapper">
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <div class="stats-grid">
                
                <!-- Practice Tests Card -->
                <div class="stats-card">
                    <div class="card-header">
                        <h2>Practice Tests</h2>
                        <span class="card-icon">‚úçÔ∏è</span>
                    </div>
                    <div class="card-body">
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Total Completed</span>
                                <span class="stat-value">{{ practice_summary.total }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Average Score</span>
                                <span class="stat-value highlight">{{ practice_summary.average }}%</span>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Highest</span>
                                <span class="stat-value success">{{ practice_summary.highest }}%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Lowest</span>
                                <span class="stat-value">{{ practice_summary.lowest }}%</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="practiceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Writing Tasks Card -->
                <div class="stats-card">
                    <div class="card-header">
                        <h2>Writing Tasks</h2>
                        <span class="card-icon">üìÑ</span>
                    </div>
                    <div class="card-body">
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Total Completed</span>
                                <span class="stat-value">{{ writing_summary.total }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Avg Length</span>
                                <span class="stat-value highlight">{{ writing_summary.average_length }}</span>
                            </div>
                        </div>
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Longest</span>
                                <span class="stat-value success">{{ writing_summary.max_length }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Shortest</span>
                                <span class="stat-value">{{ writing_summary.min_length }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flashcards Card -->
                <div class="stats-card full-width">
                    <div class="card-header">
                        <h2>Flashcard Progress</h2>
                        <span class="card-icon">üóÇÔ∏è</span>
                    </div>
                    <div class="card-body">
                        <div class="stats-row">
                            <div class="stat-item">
                                <span class="stat-label">Total Sets</span>
                                <span class="stat-value">{{ flashcard_summary.total_sets }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Completed</span>
                                <span class="stat-value success">{{ flashcard_summary.completed }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">In Progress</span>
                                <span class="stat-value highlight">{{ flashcard_summary.in_progress }}</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="flashcardChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Recent Activity Tab -->
        <div class="tab-content" id="recent">
            <div class="activity-grid">
                
                <!-- Recent Practice Tests -->
                <div class="activity-card">
                    <h2>Recent Practice Tests</h2>
                    <div class="activity-list">
                        {% if recent_practice %}
                            {% for result in recent_practice %}
                            <div class="activity-item">
                                <div class="activity-info">
                                    <span class="activity-name">{{ result.name|default:"Practice Test" }}</span>
                                    <span class="activity-date">{{ result.taken_at|date:"M d, Y - g:i A" }}</span>
                                </div>
                                <div class="activity-score {% if result.score >= 80 %}success{% elif result.score >= 60 %}warning{% else %}danger{% endif %}">
                                    {{ result.score }}%
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">No practice tests completed yet.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Writing Tasks -->
                <div class="activity-card">
                    <h2>Recent Writing Tasks</h2>
                    <div class="activity-list">
                        {% if recent_writing %}
                            {% for result in recent_writing %}
                            <div class="activity-item">
                                <div class="activity-info">
                                    <span class="activity-name">{{ result.title|default:"Writing Task" }}</span>
                                    <span class="activity-date">{{ result.taken_at|date:"M d, Y - g:i A" }}</span>
                                </div>
                                <div class="activity-score {% if result.score >= 80 %}success{% elif result.score >= 60 %}warning{% else %}danger{% endif %}">
                                    {{ result.score }}%
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="empty-message">No writing tasks completed yet.</p>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>

        <!-- Performance Tab -->
        <div class="tab-content" id="performance">
            <div class="performance-container">
                <div class="performance-card">
                    <h2>Practice Test Performance Over Time</h2>
                    <div class="chart-container-large">
                        <canvas id="practicePerformanceChart"></canvas>
                    </div>
                </div>
                
                <div class="performance-card">
                    <h2>Writing Task Performance Over Time</h2>
                    <div class="chart-container-large">
                        <canvas id="writingPerformanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div class="tab-content" id="insights">
            <div class="insights-container">
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat-card">
                        <span class="quick-stat-label">Avg Practice Score</span>
                        <span class="quick-stat-value">{{ quick_insights.avg_practice_score }}%</span>
                    </div>
                    <div class="quick-stat-card">
                        <span class="quick-stat-label">Avg Writing Length</span>
                        <span class="quick-stat-value">{{ quick_insights.avg_writing_length }}</span>
                    </div>
                    <div class="quick-stat-card">
                        <span class="quick-stat-label">Last Activity</span>
                        <span class="quick-stat-value">{{ quick_insights.recent_activity|date:"M d" }}</span>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="ai-analysis-card">
                    <h2>AI-Powered Analysis</h2>
                    <p class="ai-description">Get personalized insights based on your learning patterns</p>
                    <button id="generateInsightsBtn" class="btn-primary">
                        <span class="btn-icon">ü§ñ</span>
                        Generate AI Insights
                    </button>
                    <div id="aiInsightResult" class="ai-result hidden">
                        <div class="loading" id="loadingSpinner">
                            <div class="spinner"></div>
                            <p>Analyzing your progress...</p>
                        </div>
                        <div id="insightContent" class="insight-content"></div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Tab switching functionality
    const navBtns = document.querySelectorAll('.nav-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;
            
            navBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(t => t.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });

    // Practice distribution chart
    const practiceCtx = document.getElementById('practiceChart').getContext('2d');
    new Chart(practiceCtx, {
        type: 'bar',
        data: {
            labels: ["0-10%", "10-20%", "20-30%", "30-40%", "40-50%", "50-60%", "60-70%", "70-80%", "80-90%", "90-100%"],
            datasets: [{
                label: 'Score Distribution',
                data: {{ practice_distribution_json|safe }},
                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Flashcard progress chart
    const flashcardCtx = document.getElementById('flashcardChart').getContext('2d');
    new Chart(flashcardCtx, {
        type: 'bar',
        data: {
            labels: {{ flashcard_sets_json|safe }},
            datasets: [{
                label: '% Known',
                data: {{ flashcard_known_json|safe }},
                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Performance over time charts
    const practiceData = {{ practice_data_json|safe }};
    const writingData = {{ writing_data_json|safe }};

    // Practice performance chart
    const practicePerfCtx = document.getElementById('practicePerformanceChart').getContext('2d');
    new Chart(practicePerfCtx, {
        type: 'line',
        data: {
            labels: practiceData.map(d => new Date(d.taken_at).toLocaleDateString()),
            datasets: [{
                label: 'Score',
                data: practiceData.map(d => d.score),
                borderColor: 'rgba(99, 102, 241, 1)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Writing performance chart
    const writingPerfCtx = document.getElementById('writingPerformanceChart').getContext('2d');
    new Chart(writingPerfCtx, {
        type: 'line',
        data: {
            labels: writingData.map(d => new Date(d.taken_at).toLocaleDateString()),
            datasets: [{
                label: 'Score',
                data: writingData.map(d => d.score),
                borderColor: 'rgba(16, 185, 129, 1)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // AI Insights functionality
    const generateBtn = document.getElementById('generateInsightsBtn');
    const resultDiv = document.getElementById('aiInsightResult');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const insightContent = document.getElementById('insightContent');

    generateBtn.addEventListener('click', async () => {
        resultDiv.classList.remove('hidden');
        loadingSpinner.style.display = 'block';
        insightContent.style.display = 'none';
        generateBtn.disabled = true;

        try {
            const response = await fetch('{% url "progress:get_ai_insights" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();
            
            loadingSpinner.style.display = 'none';
            insightContent.style.display = 'block';
            
            if (data.ai_insight) {
                insightContent.innerHTML = `<p>${data.ai_insight.replace(/\n/g, '<br>')}</p>`;
            } else if (data.error) {
                insightContent.innerHTML = `<p class="error">Error: ${data.error}</p>`;
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            insightContent.style.display = 'block';
            insightContent.innerHTML = `<p class="error">Failed to generate insights. Please try again.</p>`;
        } finally {
            generateBtn.disabled = false;
        }
    });
</script>

{% endblock %}